<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Registro Semanal</title>
    <link rel="stylesheet" href="cuentas.css">
    
</head>

<body>
<header>
    <nav>
        <a href="index.html">Inicio</a>
    </nav>
</header>

<h2 style="text-align:center; color:#b8c1ec;">Registro Semanal</h2>

<form class="resumen-form" id="registroSemanalForm">
    <label for="fechaInicio">Fecha inicio:</label>
    <input type="date" id="fechaInicio" required>
    <label for="fechaFin">Fecha fin:</label>
    <input type="date" id="fechaFin" required>
    <label for="cajaAnterior">Caja anterior:</label>
    <input type="number" id="cajaAnterior" min="0" step="0.01" value="0" required>
    <label for="gastos">Gastos:</label>
    <input type="number" id="gastos" min="0" step="0.01" value="0" required>
    <button type="submit">Calcular registro semanal</button>
</form>

<div id="resultado"></div>

<h3 style="text-align:center;color:#b8c1ec;">Historial semanal</h3>
<table class="resumen-table" id="historialTable">
    <thead>
        <tr>
            <th>Periodo</th>
            <th>Caja Anterior</th>
            <th>Cuotas</th>
            <th>Préstamos</th>
            <th>Gastos</th>
            <th>Caja Final</th>
            <th>Cobro</th>
            <th>Cobro Total</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Modal -->
<div id="modal">
    <div class="box" id="modalBox">
        <!-- contenido dinámico -->
    </div>
</div>

<script>
/* ==========================
   Constantes SheetDB
   ========================== */
const SHEETDB_BASE = 'https://sheetdb.io/api/v1/np1jtc9qv7t4a';
const SHEETDB_PRESTAMOS = SHEETDB_BASE; // hoja por defecto (préstamos)
const SHEETDB_HISTORIAL = `${SHEETDB_BASE}?sheet=historial`; // para GET/POST
function historialById(id){ return `${SHEETDB_BASE}/id/${encodeURIComponent(id)}?sheet=historial`; }

/* ==========================
   Utilidades UI (modal)
   ========================== */
function mostrarModal(html){
    const modal = document.getElementById('modal');
    const box = document.getElementById('modalBox');
    box.innerHTML = html;
    modal.style.display = 'flex';
}
function cerrarModal(){
    document.getElementById('modal').style.display = 'none';
}

/* ==========================
   Cargar / Guardar Historial
   ========================== */
async function renderHistorial() {
    try {
        const res = await fetch(SHEETDB_HISTORIAL);
        const historial = await res.json();

        const tbody = document.querySelector('#historialTable tbody');
        tbody.innerHTML = '';
        // opcional: ordenar por fechaInicio descendente
        historial.sort((a,b) => String(b.fechaInicio).localeCompare(String(a.fechaInicio)));

        historial.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.fechaInicio} a ${item.fechaFin}</td>
                <td>$${Number(item.cajaAnterior || 0).toFixed(2)}</td>
                <td>$${Number(item.totalCuotas || 0).toFixed(2)}</td>
                <td>$${Number(item.totalPrestamos || 0).toFixed(2)}</td>
                <td>$${Number(item.gastos || 0).toFixed(2)}</td>
                <td>$${Number(item.cajaActual || 0).toFixed(2)}</td>
                <td>$${Number(item.totalRestantes || 0).toFixed(2)}</td>
                <td>$${Number(item.capital || 0).toFixed(2)}</td>
                <td>
                    <button class="btn btn-editar" data-id="${item.id}">Editar</button>
                    <button class="btn btn-eliminar" data-id="${item.id}">Eliminar</button>
                </td>
            `;
            // listeners
            tr.querySelector('.btn-editar').addEventListener('click', () => abrirEditar(item));
            tr.querySelector('.btn-eliminar').addEventListener('click', () => eliminarRegistro(item.id));
            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error("Error cargando historial:", error);
    }
}

async function guardarHistorial(periodo) {
    try {
        // IMPORTANTÍSIMO: generar un id único y guardarlo (como en tu ejemplo)
        const id = Date.now().toString();
        const payload = { ...periodo, id };
        const res = await fetch(SHEETDB_HISTORIAL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: [payload] })
        });
        await res.json();
        await renderHistorial();
    } catch (error) {
        console.error("Error guardando historial:", error);
    }
}

async function eliminarRegistro(id) {
    if (!confirm("¿Seguro que quieres eliminar este registro?")) return;
    try {
        await fetch(historialById(id), { method: 'DELETE' });
        await renderHistorial();
    } catch (error) {
        console.error("Error eliminando registro:", error);
    }
}

async function actualizarHistorial(id, datosParciales) {
    try {
        // SheetDB PATCH con data: { ...campos }
        await fetch(historialById(id), {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ data: datosParciales })
        });
        await renderHistorial();
    } catch (error) {
        console.error("Error actualizando historial:", error);
    }
}

/* ==========================
   Préstamos / Cuotas (cálculo)
   ========================== */
async function obtenerCuotasYPrestamos() {
    const res = await fetch(SHEETDB_PRESTAMOS);
    const prestamos = await res.json();
    let cuotas = [];
    let prestamosPeriodo = [];

    prestamos.forEach(p => {
        if (p.cuotas) {
            try {
                const arr = JSON.parse(p.cuotas);
                arr.forEach(cuota => {
                    cuotas.push({
                        monto: Number(cuota.monto),
                        fecha: cuota.fecha
                    });
                });
            } catch {}
        }
        if (p.fecha && p.monto) {
            prestamosPeriodo.push({
                monto: Number(p.monto),
                fecha: p.fecha,
                interes: Number(p.interes || 0),
                cuotas: p.cuotas ? (()=>{ try { return JSON.parse(p.cuotas); } catch { return []; } })() : []
            });
        }
    });

    const restantes = prestamosPeriodo.map(p => {
        const totalOriginal = p.monto + (p.monto * p.interes / 100);
        const totalPagado = p.cuotas.reduce((sum, cuota) => sum + Number(cuota.monto), 0);
        return totalOriginal - totalPagado;
    });

    return { cuotas, prestamosPeriodo, restantes };
}

function recalcularResumen({ fechaInicio, fechaFin, cajaAnterior, gastos }, datosPrestamos){
    const { cuotas, prestamosPeriodo, restantes } = datosPrestamos;

    const totalCuotas = cuotas
        .filter(c => c.fecha >= fechaInicio && c.fecha <= fechaFin)
        .reduce((sum, c) => sum + c.monto, 0);

    const totalPrestamos = prestamosPeriodo
        .filter(p => p.fecha >= fechaInicio && p.fecha <= fechaFin)
        .reduce((sum, p) => sum + p.monto, 0);

    const totalRestantes = restantes.reduce((sum, r) => sum + r, 0);
    const cajaActual = totalCuotas + cajaAnterior - totalPrestamos - gastos;
    const capital = cajaActual + totalRestantes;

    return {
        totalCuotas, totalPrestamos, totalRestantes, cajaActual, capital
    };
}

/* ==========================
   Form principal (agregar)
   ========================== */
document.getElementById('registroSemanalForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const fechaInicio = document.getElementById('fechaInicio').value;
    const fechaFin = document.getElementById('fechaFin').value;
    const cajaAnterior = Number(document.getElementById('cajaAnterior').value) || 0;
    const gastos = Number(document.getElementById('gastos').value) || 0;

    if (!fechaInicio || !fechaFin) {
        alert('Debes seleccionar el periodo.');
        return;
    }
    if (fechaInicio > fechaFin) {
        alert('La fecha de inicio debe ser menor o igual a la fecha de fin.');
        return;
    }

    const datosPrestamos = await obtenerCuotasYPrestamos();
    const { totalCuotas, totalPrestamos, totalRestantes, cajaActual, capital } =
        recalcularResumen({ fechaInicio, fechaFin, cajaAnterior, gastos }, datosPrestamos);

    document.getElementById('resultado').innerHTML = `
        <div class="resumen-datos">
            <h4>Resumen del periodo<br>${fechaInicio} a ${fechaFin}</h4>
            <div class="dato"><strong>Caja anterior:</strong> <span>$${cajaAnterior.toFixed(2)}</span></div>
            <div class="dato"><strong>Cuotas recogidas:</strong> <span>$${totalCuotas.toFixed(2)}</span></div>
            <div class="dato"><strong>Préstamos entregados:</strong> <span>$${totalPrestamos.toFixed(2)}</span></div>
            <div class="dato"><strong>Gastos:</strong> <span>$${gastos.toFixed(2)}</span></div>
            <div class="dato"><strong>Caja actual:</strong> <span>$${cajaActual.toFixed(2)}</span></div>
            <div class="dato"><strong>Restante por cobrar:</strong> <span>$${totalRestantes.toFixed(2)}</span></div>
            <div class="capital-final"><strong>Capital final:</strong> $${capital.toFixed(2)}</div>
        </div>
    `;

    await guardarHistorial({
        fechaInicio,
        fechaFin,
        cajaAnterior: cajaAnterior.toFixed(2),
        totalCuotas: totalCuotas.toFixed(2),
        totalPrestamos: totalPrestamos.toFixed(2),
        gastos: gastos.toFixed(2),
        cajaActual: cajaActual.toFixed(2),
        totalRestantes: totalRestantes.toFixed(2),
        capital: capital.toFixed(2)
    });

    e.target.reset();
});

/* ==========================
   Editar (modal + PATCH)
   ========================== */
function abrirEditar(item){
    const html = `
        <h3>Editar registro</h3>
        <form id="editForm">
            <label>Fecha inicio</label>
            <input type="date" id="editFechaInicio" value="${item.fechaInicio || ''}" required>
            <label>Fecha fin</label>
            <input type="date" id="editFechaFin" value="${item.fechaFin || ''}" required>
            <label>Caja anterior</label>
            <input type="number" step="0.01" id="editCajaAnterior" value="${Number(item.cajaAnterior||0)}" required>
            <label>Gastos</label>
            <input type="number" step="0.01" id="editGastos" value="${Number(item.gastos||0)}" required>

            <div class="actions">
                <button type="button" class="btn-sec" onclick="cerrarModal()">Cancelar</button>
                <button type="submit" class="btn-pri">Guardar</button>
            </div>
        </form>
    `;
    mostrarModal(html);

    document.getElementById('editForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const fechaInicio = document.getElementById('editFechaInicio').value;
        const fechaFin = document.getElementById('editFechaFin').value;
        const cajaAnterior = Number(document.getElementById('editCajaAnterior').value) || 0;
        const gastos = Number(document.getElementById('editGastos').value) || 0;

        if (!fechaInicio || !fechaFin) {
            alert('Debes seleccionar el periodo.');
            return;
        }
        if (fechaInicio > fechaFin) {
            alert('La fecha de inicio debe ser menor o igual a la fecha de fin.');
            return;
        }

        // Recalcular con los nuevos valores
        const datosPrestamos = await obtenerCuotasYPrestamos();
        const { totalCuotas, totalPrestamos, totalRestantes, cajaActual, capital } =
            recalcularResumen({ fechaInicio, fechaFin, cajaAnterior, gastos }, datosPrestamos);

        await actualizarHistorial(item.id, {
            fechaInicio,
            fechaFin,
            cajaAnterior: cajaAnterior.toFixed(2),
            totalCuotas: totalCuotas.toFixed(2),
            totalPrestamos: totalPrestamos.toFixed(2),
            gastos: gastos.toFixed(2),
            cajaActual: cajaActual.toFixed(2),
            totalRestantes: totalRestantes.toFixed(2),
            capital: capital.toFixed(2)
        });

        cerrarModal();
    });
}

/* ==========================
   Inicio
   ========================== */
renderHistorial();
</script>
</body>
</html>
